<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynamic Chart Builder</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #333; color: #fff; padding: 1rem; display: flex; align-items: center; }
    header h1 { flex: 1; margin: 0; font-size: 1.2rem; }
    header button { background: #555; color: #fff; border: none; padding: 0.5rem 1rem; cursor: pointer; }
    main { padding: 1rem; max-width: 900px; margin: auto; }
    .controls { display: flex; gap: 1rem; margin-bottom: 1rem; }
    .controls label { display: flex; flex-direction: column; font-size: 0.9rem; }
    select, button { padding: 0.5rem; font-size: 1rem; }
    canvas { background: #fff; border: 1px solid #ccc; display: block; margin: auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <header>
    <h1>Chart Builder</h1>
    <button id="backBtn">‚Üê Back to Entries</button>
  </header>
  <main>
    <div class="controls">
      <label>
        X-Axis:
        <select id="xSelect"></select>
      </label>
      <label>
        Y-Axis:
        <select id="ySelect"></select>
      </label>
      <button id="updateBtn">Update Chart</button>
    </div>
    <canvas id="chartCanvas" width="800" height="400"></canvas>
  </main>

  <script>
    (async () => {
      // Navigation
      document.getElementById('backBtn').onclick = () => window.location.href = 'south1.html';

      // Credentials
      const supabaseUrl = sessionStorage.getItem('supabaseUrl');
      const supabaseKey = sessionStorage.getItem('supabaseKey');
      if (!supabaseUrl || !supabaseKey) {
        alert('Missing Supabase credentials.');
        return window.location.href = 'south1.html';
      }
      const supabase = supabase.createClient(supabaseUrl, supabaseKey);

      // Fetch data
      const { data: entries, error } = await supabase.from('south1_entries').select('*');
      if (error || !entries) {
        console.error(error);
        return;
      }

      // Sort entries by date if available
      if (entries[0].entry_date) entries.sort((a,b) => new Date(a.entry_date) - new Date(b.entry_date));

      // Determine fields
      const fields = Object.keys(entries[0]);
      // Determine numeric fields for Y-axis default
      const numericFields = fields.filter(k => !isNaN(parseFloat(entries[0][k])));

      // Populate selectors
      const xSelect = document.getElementById('xSelect');
      const ySelect = document.getElementById('ySelect');
      fields.forEach(f => {
        const optX = new Option(f, f);
        const optY = new Option(f, f);
        xSelect.add(optX);
        ySelect.add(optY);
      });
      xSelect.value = fields.includes('entry_date') ? 'entry_date' : fields[0];
      ySelect.value = numericFields.includes('tub_press') ? 'tub_press' : (numericFields[0] || fields[1]);

      // Chart instance
      let chart;
      function renderChart(xKey, yKey) {
        const labels = entries.map(r => r[xKey]);
        const data = entries.map(r => {
          const v = parseFloat(r[yKey]);
          return isNaN(v) ? null : v;
        });
        if (chart) chart.destroy();
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: yKey, data, fill: false, tension: 0.1 }] },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: xKey } },
              y: { title: { display: true, text: yKey } }
            }
          }
        });
      }

      // Initial render
      renderChart(xSelect.value, ySelect.value);

      // Update on button click
      document.getElementById('updateBtn').onclick = () => {
        renderChart(xSelect.value, ySelect.value);
      };
    })();
  </script>
</body>
</html>
