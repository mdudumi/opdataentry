<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="dashboard-page">
  <header class="dashboard-header">
    <h1 class="dashboard-title">Data Dashboard</h1>
    <button id="backBtn" class="btn btn-secondary">‚Üê Back to Login</button>
  </header>

  <main class="dashboard-main">
    <section class="chart-section card">
      <h2 class="section-title">Chart</h2>
      <canvas id="dataChart" class="chart-canvas"></canvas>
    </section>

    <section class="stats-section card">
      <h2 class="section-title">Summary Statistics</h2>
      <div id="statsGrid" class="stats-grid"></div>
    </section>

    <section class="table-section card">
      <h2 class="section-title">Raw Data</h2>
      <button id="exportCsv" class="btn btn-primary">Export CSV</button>
      <div class="table-container">
        <table id="dataTable" class="table">
          <thead>
            <tr id="tableHead"></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // Retrieve credentials
    const supabaseUrl = sessionStorage.getItem('supabaseUrl');
    const supabaseKey = sessionStorage.getItem('supabaseKey');
    if (!supabaseUrl || !supabaseKey) window.location.href = 'south1.html';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = 'south1.html';
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: entries, error } = await supabase.from('south1-entries').select('*');
      if (error || !entries?.length) return;

      // sort by date
      entries.sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));

      // Chart
      const labels = entries.map(e => e.entry_date);
      const values = entries.map(e => parseFloat(e.tub_press) || 0);
      const ctx = document.getElementById('dataChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Tubing Pressure', data: values, borderWidth: 2, fill: false }] },
        options: { responsive: true, scales: { x: { title: { display: true, text: 'Date' } }, y: { title: { display: true, text: 'Pressure' } } } }
      });

      // Stats
      const keys = ['tub_press','cas_press','speed','fluid_level','torque','oil_press','oil_level','frecuenze','tank_volume','free_water','bsw_tank','tank_temp','water_diluent','diesel_propane','chmc'];
      const grid = document.getElementById('statsGrid');
      keys.forEach(key => {
        const vals = entries.map(e => parseFloat(e[key])).filter(n => !isNaN(n));
        if (!vals.length) return;
        const min = Math.min(...vals).toFixed(2);
        const max = Math.max(...vals).toFixed(2);
        const avg = (vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(2);
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.innerHTML = `<h3 class="stat-key">${key.replace(/_/g, ' ')}</h3>
                          <p class="stat-value">Min: ${min}</p>
                          <p class="stat-value">Max: ${max}</p>
                          <p class="stat-value">Avg: ${avg}</p>`;
        grid.appendChild(card);
      });

      // Table
      const head = document.getElementById('tableHead');
      Object.keys(entries[0]).forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.replace(/_/g, ' ');
        head.appendChild(th);
      });
      const body = document.getElementById('tableBody');
      entries.forEach(row => {
        const tr = document.createElement('tr');
        Object.values(row).forEach(val => {
          const td = document.createElement('td'); td.textContent = val; tr.appendChild(td);
        });
        body.appendChild(tr);
      });

      // CSV Export
      document.getElementById('exportCsv').addEventListener('click', () => {
        const cols = Object.keys(entries[0]);
        const csv = [cols.join(','), ...entries.map(r => cols.map(c => r[c]).join(','))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'south1_entries.csv';
        link.click();
      });
    });
  </script>
</body>
</html>
