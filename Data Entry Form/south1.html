<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOUTH 1 - RUNSHEET</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header>
    <h1>SOUTH 1 - RUNSHEET</h1>
  </header>
  <div class="container">
    <div class="left-pane">
      <form id="wellForm">
        <label for="entry_date">Entry Date</label>
        <input type="date" id="entry_date" name="entry_date" required />

        <label for="pad">Pad</label>
        <select name="pad" id="pad" required>
          <option value="">-- Select Pad --</option>
          <option value="Pad1">Pad1</option>
          <option value="Pad2">Pad2</option>
          <option value="Pad3">Pad3</option>
        </select>

        <label for="well">Well</label>
	<select name="well" id="well" required>
  	<option value="">-- Select Well --</option>
          <option value="W1">W1</option>
          <option value="W2">W2</option>
          <option value="W3">W3</option>
	</select>

        <label for="tub_press">Tubing Pressure</label>
        <input type="number" step="any" id="tub_press" name="tub_press" />

        <label for="cas_press">Casing Pressure</label>
        <input type="number" step="any" id="cas_press" name="cas_press" />

        <label for="speed">Speed</label>
        <input type="number" step="any" id="speed" name="speed" />

        <label for="fluid_level">Fluid Level</label>
        <input type="number" step="any" id="fluid_level" name="fluid_level" />

        <label for="torque">Torque</label>
        <input type="number" step="any" id="torque" name="torque" />

        <label for="oil_press">Oil Pressure</label>
        <input type="number" step="any" id="oil_press" name="oil_press" />

        <label for="oil_level">Oil Level</label>
        <input type="number" step="any" id="oil_level" name="oil_level" />

        <label for="frecuenze">Frequency</label>
        <input type="number" step="any" id="frecuenze" name="frecuenze" />

        <label for="tank_volume">Tank Volume</label>
        <input type="number" step="any" id="tank_volume" name="tank_volume" />

        <label for="free_water">Free Water</label>
        <input type="number" step="any" id="free_water" name="free_water" />

        <label for="bsw_tank">BSW Tank</label>
        <input type="number" step="any" id="bsw_tank" name="bsw_tank" />

        <label for="tank_temp">Tank Temperature</label>
        <input type="number" step="any" id="tank_temp" name="tank_temp" />

        <label for="water_diluent">Water Diluent</label>
        <input type="number" step="any" id="water_diluent" name="water_diluent" />

        <label for="diesel_propane">Diesel Propane</label>
        <input type="number" step="any" id="diesel_propane" name="diesel_propane" />

        <label for="chmc">CHMC</label>
        <input type="number" step="any" id="chmc" name="chmc" />

	<div class="footer-buttons">
        <button type="submit">Add Entry</button>
	  </div>	
	      
      </form>
    </div>
  
    <div class="right-pane">
	    
<div class="header-buttons">
    <a href="index.html" class="return-button">‚Üê Return to Index</a>
    <button id="toggleMode">Toggle Dark</button>
  </div>

	    <div class="table-wrapper">
      <table id="previewTable" aria-label="Well Data Table">
        <thead>
          <tr>
            <th>Entry Date</th>
            <th>Pad</th>
            <th>Well</th>
            <th>Tub Press</th>
            <th>Cas Press</th>
            <th>Speed</th>
            <th>Fluid Level</th>
            <th>Torque</th>
            <th>Oil Press</th>
            <th>Oil Level</th>
            <th>Frequency</th>
            <th>Tank Volume</th>
            <th>Free Water</th>
            <th>BSW Tank</th>
            <th>Tank Temp</th>
            <th>Water Diluent</th>
            <th>Diesel Propane</th>
            <th>CHMC</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
	</div>	    
              <!-- Analysis Section -->
    <div class="analysis-wrapper" id="analysis"></div>
    <!-- Chart Controls -->
    <div class="chart-controls">
      <label for="xSelect">X-Axis:</label>
      <select id="xSelect">
        <option value="entry_date">Entry Date</option>
        <option value="tub_press">Tubing Pressure</option>
        <option value="cas_press">Casing Pressure</option>
        <option value="speed">Speed</option>
        <option value="fluid_level">Fluid Level</option>
        <option value="torque">Torque</option>
        <option value="oil_press">Oil Pressure</option>
        <option value="oil_level">Oil Level</option>
        <option value="frecuenze">Frequency</option>
        <option value="tank_volume">Tank Volume</option>
        <option value="free_water">Free Water</option>
        <option value="bsw_tank">BSW Tank</option>
        <option value="tank_temp">Tank Temperature</option>
        <option value="water_diluent">Water Diluent</option>
        <option value="diesel_propane">Diesel Propane</option>
        <option value="chmc">CHMC</option>
      </select>
      <label for="ySelect">Y-Axis:</label>
      <select id="ySelect">
        <option value="entry_date">Entry Date</option>
        <option value="tub_press">Tubing Pressure</option>
        <option value="cas_press">Casing Pressure</option>
        <option value="speed">Speed</option>
        <option value="fluid_level">Fluid Level</option>
        <option value="torque">Torque</option>
        <option value="oil_press">Oil Pressure</option>
        <option value="oil_level">Oil Level</option>
        <option value="frecuenze">Frequency</option>
        <option value="tank_volume">Tank Volume</option>
        <option value="free_water">Free Water</option>
        <option value="bsw_tank">BSW Tank</option>
        <option value="tank_temp">Tank Temperature</option>
        <option value="water_diluent">Water Diluent</option>
        <option value="diesel_propane">Diesel Propane</option>
        <option value="chmc">CHMC</option>
      </select>
    </div>
    <div class="chart-wrapper">
      <canvas id="combinedChart" width="400" height="200"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/south1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Register Chart.js components and zoom plugin
    Chart.register(
      Chart.LineController,
      Chart.LineElement,
      Chart.PointElement,
      Chart.TimeScale,
      Chart.LinearScale,
      Chart.Tooltip,
      Chart.Legend,
      Chart.Zoom // plugin
    );

    const table = document.getElementById('previewTable');
    const xSelect = document.getElementById('xSelect');
    const ySelect = document.getElementById('ySelect');
    const analysisDiv = document.getElementById('analysis');
    const ctx = document.getElementById('combinedChart').getContext('2d');
    let chart;

    const mapIndex = { entry_date:0, pad:1, well:2, tub_press:3, cas_press:4, speed:5,
      fluid_level:6, torque:7, oil_press:8, oil_level:9, frecuenze:10,
      tank_volume:11, free_water:12, bsw_tank:13, tank_temp:14,
      water_diluent:15, diesel_propane:16, chmc:17 };

    function computeStats(values, key) {
      const stats = {};
      if (key === 'entry_date') {
        const dates = values.map(v => v && new Date(v)).filter(d=>d instanceof Date && !isNaN(d)).sort((a,b) => a - b);
        stats.min = dates[0] || null;
        stats.max = dates[dates.length-1] || null;
        stats.count = dates.length;
      } else {
        const nums = values.map(v => parseFloat(v)).filter(n=>!isNaN(n));
        const count = nums.length;
        const sum = nums.reduce((a,b)=>a+b,0);
        const mean = sum/count;
        const squaredDiffs = nums.map(n => Math.pow(n-mean,2));
        const variance = squaredDiffs.reduce((a,b)=>a+b,0)/count;
        const stdDev = Math.sqrt(variance);
        const min = Math.min(...nums);
        const max = Math.max(...nums);
        const sorted = nums.slice().sort((a,b)=>a-b);
        const median = count%2 ? sorted[Math.floor(count/2)] : (sorted[count/2-1]+sorted[count/2])/2;
        stats.count = count;
        stats.sum = sum;
        stats.mean = mean;
        stats.min = min;
        stats.max = max;
        stats.median = median;
        stats.variance = variance;
        stats.stdDev = stdDev;
      }
      return stats;
    }

    function computeCorrelation(xVals, yVals) {
      const xs = xVals.map(v => parseFloat(v)).filter(n=>!isNaN(n));
      const ys = yVals.map(v => parseFloat(v)).filter(n=>!isNaN(n));
      const n = Math.min(xs.length, ys.length);
      if(n===0) return null;
      const meanX = xs.reduce((a,b)=>a+b,0)/n;
      const meanY = ys.reduce((a,b)=>a+b,0)/n;
      const cov = xs.map((x,i)=> (x-meanX)*(ys[i]-meanY)).reduce((a,b)=>a+b,0)/n;
      const stdX = Math.sqrt(xs.map(x=>Math.pow(x-meanX,2)).reduce((a,b)=>a+b,0)/n);
      const stdY = Math.sqrt(ys.map(y=>Math.pow(y-meanY,2)).reduce((a,b)=>a+b,0)/n);
      return stdX && stdY ? cov/(stdX*stdY) : null;
    }

    function updateAnalysis(xKey, yKey, rawX, rawY) {
      const statsX = computeStats(rawX, xKey);
      const statsY = computeStats(rawY, yKey);
      let html = `<h3>Data Analysis</h3><ul>`;
      html += `<li><strong>${xSelect.options[xSelect.selectedIndex].text} (count: ${statsX.count}):</strong> `;
      if(xKey==='entry_date') html += `From ${statsX.min?.toLocaleDateString()} to ${statsX.max?.toLocaleDateString()}`;
      else html += `Sum ${statsX.sum}, Mean ${statsX.mean.toFixed(2)}, Min ${statsX.min}, Max ${statsX.max}, Median ${statsX.median}, SD ${statsX.stdDev.toFixed(2)}`;
      html += `</li>`;
      html += `<li><strong>${ySelect.options[ySelect.selectedIndex].text} (count: ${statsY.count}):</strong> `;
      if(yKey==='entry_date') html += `From ${statsY.min?.toLocaleDateString()} to ${statsY.max?.toLocaleDateString()}`;
      else html += `Sum ${statsY.sum}, Mean ${statsY.mean.toFixed(2)}, Min ${statsY.min}, Max ${statsY.max}, Median ${statsY.median}, SD ${statsY.stdDev.toFixed(2)}`;
      html += `</li>`;
      if(xKey!=='entry_date' && yKey!=='entry_date') {
        const corr = computeCorrelation(rawX, rawY)?.toFixed(2);
        html += `<li><strong>Pearson Correlation:</strong> ${corr}</li>`;
      }
      html += `</ul>`;
      analysisDiv.innerHTML = html;
    }

    function updateChart() {
      const xKey = xSelect.value;
      const yKey = ySelect.value;
      const rows = table.querySelectorAll('tbody tr');
      if(!rows.length) return;
      const labels = [];
      const dataY = [];
      const rawX = [];
      const rawY = [];
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const xvRaw = cells[mapIndex[xKey]]?.innerText || '';
        const yvRaw = cells[mapIndex[yKey]]?.innerText || '';
        const xv = xKey==='entry_date' ? new Date(xvRaw) : parseFloat(xvRaw);
        const yv = parseFloat(yvRaw);
        if(xKey!=='entry_date' && isNaN(xv)) return;
        if(isNaN(yv)) return;
        rawX.push(xvRaw);
        rawY.push(yvRaw);
        labels.push(xv);
        dataY.push(yv);
      });
      updateAnalysis(xKey, yKey, rawX, rawY);
      const statsX = computeStats(rawX, xKey);
      const statsY = computeStats(rawY, yKey);
      const config = {
        type: 'line',
        data: { labels, datasets:[{ label: ySelect.options[ySelect.selectedIndex].text, data: dataY, fill:false, tension:0.1, pointRadius:3 }] },
        options: {
          responsive:true,
          scales:{
            x:{
              type: xKey==='entry_date'?'time':'linear',
              min: statsX.min,
              max: statsX.max,
              time:{ unit:'day', displayFormats:{ day:'MM/dd/yyyy' }},
              title:{ display:true, text:xSelect.options[xSelect.selectedIndex].text }
            },
            y:{
              min: statsY.min,
              max: statsY.max,
              title:{ display:true, text:ySelect.options[ySelect.selectedIndex].text }
            }
          },
          plugins:{
            zoom:{
              zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'xy' },
              pan:{ enabled:true, mode:'xy' }
            }
          }
        }
      };
      if(chart) chart.config=config,chart.update(); else chart=new Chart(ctx,config);
    }

    xSelect.addEventListener('change', updateChart);
    ySelect.addEventListener('change', updateChart);
    updateChart();
  });
</script>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/south1.js"></script>

</body>
</html>
