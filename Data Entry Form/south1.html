    <!-- Chart Controls -->
    <div class="chart-controls">
      <label for="xSelect">X-Axis:</label>
      <select id="xSelect">
        <option value="entry_date">Entry Date</option>
        <option value="tub_press">Tubing Pressure</option>
        <option value="cas_press">Casing Pressure</option>
        <option value="speed">Speed</option>
        <option value="fluid_level">Fluid Level</option>
        <option value="torque">Torque</option>
        <option value="oil_press">Oil Pressure</option>
        <option value="oil_level">Oil Level</option>
        <option value="frecuenze">Frequency</option>
        <option value="tank_volume">Tank Volume</option>
        <option value="free_water">Free Water</option>
        <option value="bsw_tank">BSW Tank</option>
        <option value="tank_temp">Tank Temperature</option>
        <option value="water_diluent">Water Diluent</option>
        <option value="diesel_propane">Diesel Propane</option>
        <option value="chmc">CHMC</option>
      </select>
      <label for="ySelect">Y-Axis:</label>
      <select id="ySelect">
        <option value="entry_date">Entry Date</option>
        <option value="tub_press">Tubing Pressure</option>
        <option value="cas_press">Casing Pressure</option>
        <option value="speed">Speed</option>
        <option value="fluid_level">Fluid Level</option>
        <option value="torque">Torque</option>
        <option value="oil_press">Oil Pressure</option>
        <option value="oil_level">Oil Level</option>
        <option value="frecuenze">Frequency</option>
        <option value="tank_volume">Tank Volume</option>
        <option value="free_water">Free Water</option>
        <option value="bsw_tank">BSW Tank</option>
        <option value="tank_temp">Tank Temperature</option>
        <option value="water_diluent">Water Diluent</option>
        <option value="diesel_propane">Diesel Propane</option>
        <option value="chmc">CHMC</option>
      </select>
    </div>
    <div class="chart-wrapper">
      <canvas id="combinedChart" width="400" height="200"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/south1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Date adapter for Chart.js time scale -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const table = document.getElementById('previewTable');
    const xSelect = document.getElementById('xSelect');
    const ySelect = document.getElementById('ySelect');
    const analysisDiv = document.getElementById('analysis');
    const ctx = document.getElementById('combinedChart').getContext('2d');
    let chart;

    const mapIndex = {
      entry_date: 0, pad:1, well:2, tub_press:3, cas_press:4, speed:5,
      fluid_level:6, torque:7, oil_press:8, oil_level:9, frecuenze:10,
      tank_volume:11, free_water:12, bsw_tank:13, tank_temp:14,
      water_diluent:15, diesel_propane:16, chmc:17
    };

    function computeStats(values, key) {
      if (key === 'entry_date') {
        const dates = values.map(v => new Date(v)).sort((a,b) => a - b);
        return { min: dates[0].toLocaleDateString(), max: dates[dates.length-1].toLocaleDateString() };
      }
      const nums = values.map(v => parseFloat(v) || 0);
      const sum = nums.reduce((a,b)=>a+b,0);
      const mean = (sum/nums.length).toFixed(2);
      const min = Math.min(...nums).toFixed(2);
      const max = Math.max(...nums).toFixed(2);
      const sorted = nums.slice().sort((a,b)=>a-b);
      const mid = Math.floor(nums.length/2);
      const median = (nums.length%2 ? sorted[mid] : ((sorted[mid-1]+sorted[mid])/2)).toFixed(2);
      return { mean, min, max, median };
    }

    function updateAnalysis(xKey, yKey, rawX, rawY) {
      const statsX = computeStats(rawX, xKey);
      const statsY = computeStats(rawY, yKey);
      let html = '<h3>Data Analysis</h3><ul>';
      html += `<li><strong>${xSelect.options[xSelect.selectedIndex].text}:</strong> `;
      if (xKey === 'entry_date') html += `From ${statsX.min} to ${statsX.max}`;
      else html += `Mean: ${statsX.mean}, Min: ${statsX.min}, Max: ${statsX.max}, Median: ${statsX.median}`;
      html += '</li>';
      html += `<li><strong>${ySelect.options[ySelect.selectedIndex].text}:</strong> `;
      if (yKey === 'entry_date') html += `From ${statsY.min} to ${statsY.max}`;
      else html += `Mean: ${statsY.mean}, Min: ${statsY.min}, Max: ${statsY.max}, Median: ${statsY.median}`;
      html += '</li></ul>';
      analysisDiv.innerHTML = html;
    }

    function updateChart() {
      const xKey = xSelect.value;
      const yKey = ySelect.value;
      const rows = table.querySelectorAll('tbody tr');
      const points = [];
      const rawX = [];
      const rawY = [];

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const xv = cells[mapIndex[xKey]].innerText;
        const yv = cells[mapIndex[yKey]].innerText;
        rawX.push(xv);
        rawY.push(yv);
        const xVal = xKey === 'entry_date' ? new Date(xv) : parseFloat(xv) || 0;
        const yVal = yKey === 'entry_date' ? new Date(yv) : parseFloat(yv) || 0;
        points.push({ x: xVal, y: yVal });
      });

      updateAnalysis(xKey, yKey, rawX, rawY);

      const dataset = [{
        label: `${xSelect.options[xSelect.selectedIndex].text} vs ${ySelect.options[ySelect.selectedIndex].text}`,
        data: points,
        showLine: false,
        pointRadius: 5
      }];

      const scales = {
        x: { type: xKey === 'entry_date' ? 'time' : 'linear', title: { display: true, text: xSelect.options[xSelect.selectedIndex].text } },
        y: { type: yKey === 'entry_date' ? 'time' : 'linear', title: { display: true, text: ySelect.options[ySelect.selectedIndex].text } }
      };

      const config = { type: 'scatter', data: { datasets: dataset }, options: { responsive: true, scales } };

      if (chart) chart.config = config, chart.update();
      else chart = new Chart(ctx, config);
    }

    xSelect.addEventListener('change', updateChart);
    ySelect.addEventListener('change', updateChart);
    updateChart();
  });
</script>
