<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOUTH 1 - RUNSHEET (Updated)</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header>
  <h1>SOUTH 1 - RUNSHEET</h1>
</header>
<div class="container">
  <div class="left-pane">
    <form id="wellForm">
      <label for="entry_date">Entry Date</label>
      <input type="date" id="entry_date" name="entry_date" required />

      <label for="pad">Pad</label>
      <select name="pad" id="pad" required>
        <option value="">-- Select Pad --</option>
        <option value="Pad1">Pad1</option>
        <option value="Pad2">Pad2</option>
        <option value="Pad3">Pad3</option>
      </select>

      <!-- New: Entity Type -->
      <label for="entity_type">Entity Type</label>
      <select name="entity_type" id="entity_type" required>
        <option value="">-- Select Type --</option>
        <option value="Well">Well</option>
        <option value="Tank">Tank</option>
        <option value="Water/Diluent">Water/Diluent</option>
        <option value="Diesel/Propane">Diesel/Propane</option>
        <option value="Chemical">Chemical</option>
      </select>

      <!-- Renamed: Entity (formerly Well) -->
      <label for="entity">Entity</label>
      <select name="entity" id="entity" required>
        <option value="">-- Select Entity --</option>
        <!-- Populated dynamically based on pad + type -->
      </select>

      <!-- New: Operator Comment -->
      <label for="operator_comment">Operator Comment</label>
      <textarea id="operator_comment" name="operator_comment" rows="2"></textarea>

        <label for="tub_press">Tubing Pressure</label>
        <input type="number" step="any" id="tub_press" name="tub_press" />

        <label for="cas_press">Casing Pressure</label>
        <input type="number" step="any" id="cas_press" name="cas_press" />

        <label for="speed">Speed</label>
        <input type="number" step="any" id="speed" name="speed" />

        <label for="fluid_level">Fluid Level</label>
        <input type="number" step="any" id="fluid_level" name="fluid_level" />

        <label for="torque">Torque</label>
        <input type="number" step="any" id="torque" name="torque" />

        <label for="oil_press">Oil Pressure</label>
        <input type="number" step="any" id="oil_press" name="oil_press" />

        <label for="oil_level">Oil Level</label>
        <input type="number" step="any" id="oil_level" name="oil_level" />

        <label for="frecuenze">Frequency</label>
        <input type="number" step="any" id="frecuenze" name="frecuenze" />

        <label for="tank_volume">Tank Volume</label>
        <input type="number" step="any" id="tank_volume" name="tank_volume" />

        <label for="free_water">Free Water</label>
        <input type="number" step="any" id="free_water" name="free_water" />

        <label for="bsw_tank">BSW Tank</label>
        <input type="number" step="any" id="bsw_tank" name="bsw_tank" />

        <label for="tank_temp">Tank Temperature</label>
        <input type="number" step="any" id="tank_temp" name="tank_temp" />

        <label for="water_diluent">Water Diluent</label>
        <input type="number" step="any" id="water_diluent" name="water_diluent" />

        <label for="diesel_propane">Diesel Propane</label>
        <input type="number" step="any" id="diesel_propane" name="diesel_propane" />

        <label for="chmc">CHMC</label>
        <input type="number" step="any" id="chmc" name="chmc" />

	<div class="footer-buttons">
        <button type="submit">Add Entry</button>
	  </div>	
	      
      </form>
    </div>
 <!-- Management: Pad-Entity mappings -->
    <div class="mapping-manager">
      <h3>Manage Pad ↔ Type ↔ Entities</h3>
      <button id="openMapping">Configure Mappings</button>
      <div id="mappingModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span class="close">&times;</span>
          <table id="mappingTable">
            <thead>
              <tr><th>Pad</th><th>Type</th><th>Entity Name</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="modal-footer">
            <select id="map_pad"><option value="">Pad</option><option>Pad1</option><option>Pad2</option><option>Pad3</option></select>
            <select id="map_type"><option value="">Type</option><option>Well</option><option>Tank</option><option>Water/Diluent</option><option>Diesel/Propane</option><option>Chemical</option></select>
            <input id="map_entity" placeholder="Entity Name" />
            <button id="addMapping">Add</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="right-pane"> 
  <div class="header-buttons">
      <a href="index.html" class="return-button">← Return to Index</a>
      <button id="toggleMode">Toggle Dark</button>
    </div>
    <div class="table-wrapper">
      <table id="previewTable" aria-label="Well Data Table">
        <thead>
          <tr>
            <th>Entry Date</th>
            <th>Pad</th>
            <th>Entity Type</th>
            <th>Entity</th>
	    <th>Operator Comment</th>
            <th>Tub Press</th>
            <th>Cas Press</th>
            <th>Speed</th>
            <th>Fluid Level</th>
            <th>Torque</th>
            <th>Oil Press</th>
            <th>Oil Level</th>
            <th>Frequency</th>
            <th>Tank Volume</th>
            <th>Free Water</th>
            <th>BSW Tank</th>
            <th>Tank Temp</th>
            <th>Water Diluent</th>
            <th>Diesel Propane</th>
            <th>CHMC</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
	</div>	    
              <!-- Analysis Section -->
     <div class="analysis-wrapper" id="analysis"></div>
    <div class="chart-controls">
      <label for="var2Select">Horizontal (X) Variable:</label>
      <select id="var2Select">
        <option value="entry_date">Entry Date</option>
        <option value="pad">Pad</option>
        <option value="entity">Entity</option>
        <option value="tub_press">Tubing Pressure</option>
        <option value="cas_press">Casing Pressure</option>
        <option value="speed">Speed</option>
        <option value="fluid_level">Fluid Level</option>
        <option value="torque">Torque</option>
        <option value="oil_press">Oil Pressure</option>
        <option value="oil_level">Oil Level</option>
        <option value="frecuenze">Frequency</option>
        <option value="tank_volume">Tank Volume</option>
        <option value="free_water">Free Water</option>
        <option value="bsw_tank">BSW Tank</option>
        <option value="tank_temp">Tank Temperature</option>
        <option value="water_diluent">Water Diluent</option>
        <option value="diesel_propane">Diesel Propane</option>
        <option value="chmc">CHMC</option>
      </select>
      <label for="var1Select">Primary Vertical (Y) Variable:</label>
      <select id="var1Select">
        <option value="tub_press">Tubing Pressure</option>
        <option value="cas_press">Casing Pressure</option>
        <option value="speed">Speed</option>
        <option value="fluid_level">Fluid Level</option>
        <option value="torque">Torque</option>
        <option value="oil_press">Oil Pressure</option>
        <option value="oil_level">Oil Level</option>
        <option value="frecuenze">Frequency</option>
        <option value="tank_volume">Tank Volume</option>
        <option value="free_water">Free Water</option>
        <option value="bsw_tank">BSW Tank</option>
        <option value="tank_temp">Tank Temperature</option>
        <option value="water_diluent">Water Diluent</option>
        <option value="diesel_propane">Diesel Propane</option>
        <option value="chmc">CHMC</option>
      </select>
      <label for="var3Select">Secondary Vertical (Y2) Variable:</label>
      <select id="var3Select">
        <option value="tub_press">Tubing Pressure</option>
        <option value="cas_press">Casing Pressure</option>
        <option value="speed">Speed</option>
        <option value="fluid_level">Fluid Level</option>
        <option value="torque">Torque</option>
        <option value="oil_press">Oil Pressure</option>
        <option value="oil_level">Oil Level</option>
        <option value="frecuenze">Frequency</option>
        <option value="tank_volume">Tank Volume</option>
        <option value="free_water">Free Water</option>
        <option value="bsw_tank">BSW Tank</option>
        <option value="tank_temp">Tank Temperature</option>
        <option value="water_diluent">Water Diluent</option>
        <option value="diesel_propane">Diesel Propane</option>
        <option value="chmc">CHMC</option>
      </select>
    </div>
    <div class="chart-wrapper">
      <canvas id="combinedChart" width="400" height="200"></canvas>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/south1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script>
// Load or init mappings
let mappings = JSON.parse(localStorage.getItem('mappings') || '[]');

function saveMappings() {
  localStorage.setItem('mappings', JSON.stringify(mappings));
}

function refreshMappingTable() {
  const tbody = document.querySelector('#mappingTable tbody');
  tbody.innerHTML = '';
  mappings.forEach((m, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${m.pad}</td><td>${m.type}</td><td>${m.entity}</td><td><button data-i="${i}" class="delMap">Delete</button></td>`;
    tbody.appendChild(row);
  });
}

document.getElementById('openMapping').addEventListener('click', ()=>{
  refreshMappingTable();
  document.getElementById('mappingModal').style.display = 'block';
});
document.querySelector('.close').addEventListener('click', ()=>{
  document.getElementById('mappingModal').style.display = 'none';
});
document.getElementById('addMapping').addEventListener('click', ()=>{
  const pad = document.getElementById('map_pad').value;
  const type = document.getElementById('map_type').value;
  const ent = document.getElementById('map_entity').value.trim();
  if(pad && type && ent) {
    mappings.push({pad, type, entity: ent}); saveMappings(); refreshMappingTable();
    document.getElementById('map_entity').value='';
  }
});
document.querySelector('#mappingTable').addEventListener('click', e=>{
  if(e.target.classList.contains('delMap')){
    mappings.splice(e.target.dataset.i,1); saveMappings(); refreshMappingTable();
  }
});

// Update entity dropdown based on pad + type
function updateEntities() {
  const pad = document.getElementById('pad').value;
  const type = document.getElementById('entity_type').value;
  const select = document.getElementById('entity');
  select.innerHTML = '<option value="">-- Select Entity --</option>';
  mappings.filter(m=>m.pad===pad && m.type===type)
    .forEach(m=> select.innerHTML += `<option value="${m.entity}">${m.entity}</option>`);
}
['pad','entity_type'].forEach(id=>{
  document.getElementById(id).addEventListener('change', updateEntities);
});

// Existing form submission logic must now also read operator_comment and entity_type & entity
const form = document.getElementById('wellForm');
form.addEventListener('submit', e=>{
  e.preventDefault();
  const data = new FormData(form);
  const row = document.createElement('tr');
  const fields = ['entry_date','pad','entity_type','entity','operator_comment','tub_press', /* etc */];
  fields.forEach(key=>{
    const td = document.createElement('td');
    td.innerText = data.get(key) || '';
    row.appendChild(td);
  });
  // add action cell
  const act = document.createElement('td'); act.innerHTML='<button class="delRow">Delete</button>';
  row.appendChild(act);
  document.querySelector('#previewTable tbody').appendChild(row);
  form.reset();
});

// delete rows
document.querySelector('#previewTable tbody').addEventListener('click', e=>{
  if(e.target.classList.contains('delRow')) e.target.closest('tr').remove();
});

// ... keep the chart and analysis scripts unchanged ...
</script>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/south1.js"></script>

</body>
</html>
