<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOUTH 1 - RUNSHEET</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    SOUTH 1 - RUNSHEET
    <a href="index.html" class="return-button">← Return to Index</a>
    <button id="toggleMode" aria-label="Toggle dark mode">Toggle Dark</button>
  </header>

  <div class="container">
    <div class="left-pane">
      <form id="wellForm">
        <label for="entry_date">Entry Date</label>
        <input type="date" id="entry_date" name="entry_date" required />

        <label for="pad">Pad</label>
        <select id="pad" name="pad" required>
          <option value="">-- Select Pad --</option>
          <option value="Pad1">Pad1</option>
          <option value="Pad2">Pad2</option>
          <option value="Pad3">Pad3</option>
        </select>

        <label for="well">Well</label>
        <select id="well" name="well" required>
          <option value="">-- Select Well --</option>
        </select>

        <label for="tub_press">Tubing Pressure</label>
        <input type="number" step="any" id="tub_press" name="tub_press" />

        <label for="cas_press">Casing Pressure</label>
        <input type="number" step="any" id="cas_press" name="cas_press" />

        <label for="speed">Speed</label>
        <input type="number" step="any" id="speed" name="speed" />

        <label for="fluid_level">Fluid Level</label>
        <input type="number" step="any" id="fluid_level" name="fluid_level" />

        <label for="torque">Torque</label>
        <input type="number" step="any" id="torque" name="torque" />

        <label for="oil_press">Oil Pressure</label>
        <input type="number" step="any" id="oil_press" name="oil_press" />

        <label for="oil_level">Oil Level</label>
        <input type="number" step="any" id="oil_level" name="oil_level" />

        <label for="frecuenze">Frequency</label>
        <input type="number" step="any" id="frecuenze" name="frecuenze" />

        <label for="tank_volume">Tank Volume</label>
        <input type="number" step="any" id="tank_volume" name="tank_volume" />

        <label for="free_water">Free Water</label>
        <input type="number" step="any" id="free_water" name="free_water" />

        <label for="bsw_tank">BSW Tank</label>
        <input type="number" step="any" id="bsw_tank" name="bsw_tank" />

        <label for="tank_temp">Tank Temperature</label>
        <input type="number" step="any" id="tank_temp" name="tank_temp" />

        <label for="water_diluent">Water Diluent</label>
        <input type="number" step="any" id="water_diluent" name="water_diluent" />

        <label for="diesel_propane">Diesel Propane</label>
        <input type="number" step="any" id="diesel_propane" name="diesel_propane" />

        <label for="chmc">CHMC</label>
        <input type="number" step="any" id="chmc" name="chmc" />

        <button type="submit">Add Entry</button>
      </form>
    </div>

    <div class="right-pane">
      <div class="filters">
        <select id="dateFilter" title="Filter by Entry Date">
          <option value="">All Dates</option>
        </select>
        <select id="padFilter" title="Filter by Pad">
          <option value="">All PADs</option>
        </select>
        <select id="wellFilter" title="Filter by Well">
          <option value="">All Wells</option>
        </select>
        <button id="exportBtn" title="Export table as CSV">Export CSV</button>
      </div>

      <table id="previewTable" aria-label="Well Data Table">
        <thead>
          <tr>
            <th>Entry Date</th>
            <th>Pad</th>
            <th>Well</th>
            <th>Tubing Pressure</th>
            <th>Casing Pressure</th>
            <th>Speed</th>
            <th>Fluid Level</th>
            <th>Torque</th>
            <th>Oil Pressure</th>
            <th>Oil Level</th>
            <th>Frequency</th>
            <th>Tank Volume</th>
            <th>Free Water</th>
            <th>BSW Tank</th>
            <th>Tank Temp</th>
            <th>Water Diluent</th>
            <th>Diesel Propane</th>
            <th>CHMC</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="js/script.js"></script>
  <script>
    // map your Postgres column names → the IDs you gave your inputs
    const columnToInputId = {
      entry_date:      'entry_date',
      pad:             'pad',
      well:            'well',
      tubing_pressure: 'tub_press',
      casing_pressure: 'cas_press',
      speed:           'speed',
      fluid_level:     'fluid_level',
      torque:          'torque',
      oil_pressure:    'oil_press',
      oil_level:       'oil_level',
      frequency:       'frecuenze',
      tank_volume:     'tank_volume',
      free_water:      'free_water',
      bsw_tank:        'bsw_tank',
      tank_temp:       'tank_temp',
      water_diluent:   'water_diluent',
      diesel_propane:  'diesel_propane',
      chmc:            'chmc'
    };

    // 1) load the latest entry and fill the form
    async function loadEntry() {
      const res  = await fetch('/.netlify/functions/getentries');
      const rows = await res.json();
      const e    = rows[0] || {};
      // for each column, find the matching input and set its value
      Object.entries(columnToInputId).forEach(([col, id]) => {
        const input = document.getElementById(id);
        if (!input) return;
        // if it's a date input, strip time off
        input.value = e[col] != null
          ? (col === 'entry_date'
              ? new Date(e[col]).toISOString().slice(0,10)
              : e[col])
          : '';
      });
      // stash the PK so update knows which row to touch
      if (e.id) document.getElementById('wellForm').dataset.id = e.id;
    }

    // 2) on submit, POST everything back to updateEntry
    document.getElementById('wellForm').addEventListener('submit', async ev => {
      ev.preventDefault();
      const form = ev.target;
      const payload = { id: form.dataset.id }; 
      // collect all the form fields
      Object.entries(columnToInputId).forEach(([col, id]) => {
        payload[col] = document.getElementById(id).value;
      });

      const upd = await fetch('/.netlify/functions/updateEntry', {
        method: 'POST',
        body:   JSON.stringify(payload),
      });

      if (upd.ok) {
        alert('✅ Saved!');
        loadEntry();   // refresh in case anything changed
      } else {
        alert('❌ Error: ' + await upd.text());
      }
    });

    // run on page load
    window.addEventListener('DOMContentLoaded', loadEntry);
  </script>
</body>
</html>
